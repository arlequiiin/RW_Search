"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ—Ä–µ–∑ Claude Sonnet 4.5

–°–æ–∑–¥–∞—ë—Ç JSON —Ñ–∞–π–ª —Å –ø–µ—Ä–≤—ã–º–∏ 50 –¥–∏–∞–ª–æ–≥–∞–º–∏ –¥–ª—è —Ç–µ—Å—Ç–∞
"""

import re
import json
from pathlib import Path


def parse_markdown_dialogues(md_file: str, limit: int = None) -> list:
    """
    –ü–∞—Ä—Å–∏–Ω–≥ markdown —Ñ–∞–π–ª–∞ —Å –¥–∏–∞–ª–æ–≥–∞–º–∏

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
    [
        {
            "id": 1,
            "title": "–ó–∞–≥–æ–ª–æ–≤–æ–∫",
            "date": "2023-02-16 05:25",
            "content": "—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞"
        },
        ...
    ]
    """
    with open(md_file, 'r', encoding='utf-8') as f:
        content = f.read()

    # –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ ---
    sections = content.split('\n---\n')

    dialogues = []

    for idx, section in enumerate(sections):
        if not section.strip():
            continue

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ —Å #)
        title_match = re.search(r'^#\s+(.+?)$', section, re.MULTILINE)
        title = title_match.group(1).strip() if title_match else f"–î–∏–∞–ª–æ–≥ {idx+1}"

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É
        date_match = re.search(r'\*\*–î–∞—Ç–∞:\*\*\s+(.+?)$', section, re.MULTILINE)
        date = date_match.group(1).strip() if date_match else "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∏–∞–ª–æ–≥ (–≤—Å—ë –ø–æ—Å–ª–µ "**–î–∏–∞–ª–æ–≥:**")
        dialogue_match = re.search(r'\*\*–î–∏–∞–ª–æ–≥:\*\*\s*\n\n(.+)', section, re.DOTALL)
        dialogue_content = dialogue_match.group(1).strip() if dialogue_match else section

        dialogues.append({
            "id": idx + 1,
            "original_title": title,
            "date": date,
            "content": dialogue_content
        })

        if limit and len(dialogues) >= limit:
            break

    return dialogues


def create_claude_prompt(dialogues: list) -> str:
    """
    –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è Claude
    """
    prompt = """–ü—Ä–∏–≤–µ—Ç! –Ø –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —ç–∫—Å–ø–æ—Ä—Ç —á–∞—Ç–∞ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏–∑ Telegram. –ü–æ–ª—É—á–∏–ª–æ—Å—å 428 –¥–∏–∞–ª–æ–≥–æ–≤, –Ω–æ –º–Ω–æ–≥–∏–µ –∏–∑ –Ω–∏—Ö ‚Äî —Å–ª—É–∂–µ–±–Ω–∞—è –ø–µ—Ä–µ–ø–∏—Å–∫–∞, –∑–∞–¥–∞—á–∏ –∏–ª–∏ –æ—Ñ—Ñ—Ç–æ–ø.

–ú–Ω–µ –Ω—É–∂–Ω–∞ —Ç–≤–æ—è –ø–æ–º–æ—â—å –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∏–∞–ª–æ–≥–æ–≤. –í–æ—Ç —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:

## –ó–∞–¥–∞—á–∞:

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞:

1. **–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫** (–º–∞–∫—Å–∏–º—É–º 10 —Å–ª–æ–≤):
   - –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ–ª–∂–µ–Ω –æ—Ç—Ä–∞–∂–∞—Ç—å –°–£–¢–¨ –ø—Ä–æ–±–ª–µ–º—ã/–∑–∞–¥–∞—á–∏
   - –ò–∑–±–µ–≥–∞—Ç—å –æ–ø–µ—á–∞—Ç–æ–∫ –∏ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π
   - –ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤:
     - ‚ùå "–°–æ —Å —Ä–æ–±–æ—Ç–æ–º 027?"
     - ‚úÖ "–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ä–æ–±–æ—Ç–æ–º –Ω–∞ –º–∞–≥–∞–∑–∏–Ω–µ 027"
     - ‚ùå "90043 –∑–∞–º–µ–Ω–∏—Ç—å –¥–∂–∞–∫–∞—Ä—Ç—É"
     - ‚úÖ "–ó–∞–º–µ–Ω–∞ Jakarta –∏ –∑–∞–ø—É—Å–∫ —Ä–æ–±–æ—Ç–∞ –ï–ì–ê–ò–° –Ω–∞ –º–∞–≥–∞–∑–∏–Ω–µ 90043"

2. **–ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –¥–∏–∞–ª–æ–≥** –≤ –æ–¥–Ω—É –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:
   - **"–ø–æ–ª–µ–∑–Ω—ã–π"** ‚Äî –µ—Å—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –∏/–∏–ª–∏ —Ä–µ—à–µ–Ω–∏–µ, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
   - **"–∑–∞–¥–∞—á–∞"** ‚Äî —Å–ª—É–∂–µ–±–Ω–æ–µ –ø–æ—Ä—É—á–µ–Ω–∏–µ –±–µ–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–Ω–∞–ø–∏—à–∏ —É—á—ë—Ç–∫—É", "–ø—Ä–æ–≤–µ—Ä—å –±–∞–∑—É")
   - **"–æ—Ñ—Ñ—Ç–æ–ø"** ‚Äî –ø—É—Å—Ç—ã–µ –¥–∏–∞–ª–æ–≥–∏, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è, –Ω–µ—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–ø–∏—Å–∫–∞
   - **"–Ω–µ—è—Å–Ω–æ"** ‚Äî —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è

3. **–ö—Ä–∞—Ç–∫–æ –æ–±—ä—è—Å–Ω–∏—Ç—å** –ø–æ—á–µ–º—É –≤—ã–±—Ä–∞–Ω–∞ —ç—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)

## –ö–æ–Ω—Ç–µ–∫—Å—Ç:

–≠—Ç–æ —á–∞—Ç –º–µ–∂–¥—É —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º (–°—Ç–∞—Å) –∏ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–æ–π (–ï–ì–ê–ò–°/1–°).
–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã: –ï–ì–ê–ò–°, –£–¢–ú, —Ä–æ–±–æ—Ç, –º–∞—Ä–∫–∏, 1–°, Jakarta, –±–∞–∑–∞, –º–∞–≥–∞–∑–∏–Ω (–Ω–æ–º–µ—Ä–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤), FTP.

## –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:

–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –≤–∏–¥–µ **JSON –º–∞—Å—Å–∏–≤–∞**:

```json
[
  {
    "id": 1,
    "original_title": "...",
    "new_title": "...",
    "category": "–ø–æ–ª–µ–∑–Ω—ã–π|–∑–∞–¥–∞—á–∞|–æ—Ñ—Ñ—Ç–æ–ø|–Ω–µ—è—Å–Ω–æ",
    "reason": "–ü–æ—á–µ–º—É —Ç–∞–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)"
  },
  ...
]
```

**–í–ê–ñ–ù–û:** –û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û JSON –º–∞—Å—Å–∏–≤–æ–º, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ.

---

## –î–∏–∞–ª–æ–≥–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:

"""

    # –î–æ–±–∞–≤–ª—è–µ–º –¥–∏–∞–ª–æ–≥–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
    prompt += "```json\n"
    prompt += json.dumps(dialogues, ensure_ascii=False, indent=2)
    prompt += "\n```\n"

    return prompt


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""

    MD_FILE = "data/docs/—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å_–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.md"
    OUTPUT_JSON = "temp_claude_dialogues.json"
    OUTPUT_PROMPT = "temp_claude_prompt.txt"

    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∞
    TEST_LIMIT = 50  # –ù–∞—á–Ω—ë–º —Å 50 –¥–∏–∞–ª–æ–≥–æ–≤

    print(f"üîç –ü–∞—Ä—Å–∏–Ω–≥ –¥–∏–∞–ª–æ–≥–æ–≤ –∏–∑ {MD_FILE}...")
    dialogues = parse_markdown_dialogues(MD_FILE, limit=TEST_LIMIT)
    print(f"   –ò–∑–≤–ª–µ—á–µ–Ω–æ –¥–∏–∞–ª–æ–≥–æ–≤: {len(dialogues)}")

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∏–∞–ª–æ–≥–∏ –≤ JSON
    print(f"üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤ –≤ {OUTPUT_JSON}...")
    with open(OUTPUT_JSON, 'w', encoding='utf-8') as f:
        json.dump(dialogues, f, ensure_ascii=False, indent=2)

    # –°–æ–∑–¥–∞—ë–º –ø—Ä–æ–º–ø—Ç –¥–ª—è Claude
    print(f"üìù –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è Claude...")
    prompt = create_claude_prompt(dialogues)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–º–ø—Ç
    with open(OUTPUT_PROMPT, 'w', encoding='utf-8') as f:
        f.write(prompt)

    print(f"\n‚úÖ –ì–æ—Ç–æ–≤–æ!")
    print(f"   –§–∞–π–ª —Å –ø—Ä–æ–º–ø—Ç–æ–º: {OUTPUT_PROMPT}")
    print(f"   –†–∞–∑–º–µ—Ä –ø—Ä–æ–º–ø—Ç–∞: {len(prompt)} —Å–∏–º–≤–æ–ª–æ–≤ (~{len(prompt)//4} —Ç–æ–∫–µ–Ω–æ–≤)")
    print(f"\nüìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:")
    print(f"   1. –û—Ç–∫—Ä–æ–π —Ñ–∞–π–ª: {OUTPUT_PROMPT}")
    print(f"   2. –°–∫–æ–ø–∏—Ä—É–π –≤–µ—Å—å —Ç–µ–∫—Å—Ç")
    print(f"   3. –ü–µ—Ä–µ–π–¥–∏ –Ω–∞ https://claude.ai")
    print(f"   4. –í—Å—Ç–∞–≤—å –ø—Ä–æ–º–ø—Ç –≤ –Ω–æ–≤—ã–π —á–∞—Ç")
    print(f"   5. –î–æ–∂–¥–∏—Å—å –æ—Ç–≤–µ—Ç–∞ –æ—Ç Claude")
    print(f"   6. –°–∫–æ–ø–∏—Ä—É–π JSON –æ—Ç–≤–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–∏ –≤ —Ñ–∞–π–ª 'claude_response.json'")


if __name__ == "__main__":
    main()
