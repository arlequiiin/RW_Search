В эталонке делаем базы пароль 456456
В 1С *эталон* КБ (наши) и *куба* (магазины в Крыму и новые территории) 
Наши на 30ххх, кубинские 90ххх

Эталон
в 23:20 обновляются справочники, но бывают не обновляются (операция отклонена)
Примерно час на обновление 
Около 00:20 проверить Эталон чтобы обновления справочники 

Как проверить справочники:
Если последний пользователь Robot_tmc 
Справочники - контролируемые параметры 
То тогда строки:
- Цены_1 
- Дисконт 
- ТМЦ 
должны быть обновлены.

Если не обновлены, на С есть папка backup, батник backuptestftp.bat, он делает то же самое, что и планировщик 

На кубинский не обновляется 

Далее обновляем конфиги (на рабочем столе) и только потом обрезка базы

Затем обрезка по инструкции в rw

*После 6 пункта...* 
*Можнл скопировать все магазины, идём в переименовать мазагин(внизу) , в столбец магазины вставляем все, затем копируем из результаты обратно в таблицу, чтобы убрать знаки препинания ( ctrl + shift + v ).* 

Когда болванка готова, её потом будем закидывать на магазин 

Пункт "на своём компе качаем архивы с маоуасм" уже не делаем 

ВЫГРУЗКА ДОКУМЕНТОВ 
в 1с магазина 
Рядом с FTP красный чел "выгрузка документов"

Когда все болванки будут готовы на раб столе открыть батник kb_y base, он откроет три папки 
1 папка с диск с болванками
2  kb_y/base/cutdb 
3 еда вода 
Вырезать из 1 в остальные болванки

Что дальше делаем на магазинах. Заходим на обрезанные магазины 
(в папке обрезка базы есть батник для обрезки бд и для обрезки базы данных (консольные)), если еда вода позвонит, то батник еда вода. 
Вся обрезка базы происходит на сервере, копируем на сервер и запускаем "для обрезки бд" 
Он качает новую ТМ, затем он удаляет старую и ставит новую. После он создаёт папку 

Сначала качаем остатки rw
RW все
Создаём болванки в эталонке
Скидываем болванки на kb_y
С Эталонкой на этом всё 

Далее работаем с магазинами которые надо резать :
    1. Запускаем батник
    2. Затем закинуть болванки на d диск текущего магазина 

# **06.10.25** **1С Обрезка базы**

1. Обновляю (проверяю) справочники 

2. Подключаюсь на админские кассы и запускаю батник "запустить на админской кассе при обрезке"

3. Затем подключившись в тени на магазины запускаю батник "для обрезки базы БД"

4. Делаю болванки

5. Запускаю "Обрезка базы данных (консольное)"


## 1. RW качаем остатки
Для болванок нужно переименовать по образцу названия магазинов в гугл таблице 

В RW в синем квадрате открываем продажи (синий куб), проверяем розничные продажи за предыдущее число (если магазин плюсовой, то за сегодняшнее)

**Когда обрезка плюсовых магазинов (точнее у кого плохо с логистикой), то берём выгрузку остатков в RW:** 
Сервис - доп и внешние отчеты и обработки - в отбор ввести ==выгрузка остатков и номеров документов для восстановления магазина==. (Называется точно так же, как и в операции - обработки. В сервисе выгружает только за 60 дней, тогда как в операции все документы) 

Затем операции - обработка - выгрузка остатков и номеров 
Ввести номер магазина (путь не трогаем, он диск C), нажимаем выполнить 
Он качает архив с остатками на наш диск C 

## 2. Обновление справочников

Заходим на эталонку (rdp), открываем 1с - эталон кб (для еды воды выбираем Куба эталон) под программистом. 
 
Заходим справочники - контролируемые параметры. Тут будет загружено цены 1, тмц и дисконт. Если будут не загружены, то зайти на диск C (в эталонке ), в папке backup запускаем батник backuptestftp (он долго отрабатывает)

Возможно планировщик не смог обработать, так как кто-то был в это время в 1С

## 3. Создание болванки
В Эталонке заходим под программистом в конфигуратор. Из под него заходим в 1С
Обработки - обработки прочее - превращаем эталонную базу в новую 
Вводим номер магазина (для новых магазинов "база с остатками" не ставим)
Выходит окно выбрать файл - жмем отмена 
Затем не выходим 
В константах проверяем правильный ли магазин 
Операции - обработка - Загрузка остатков и номеров документов. Загружаем с нашего диска С остатки (архив)
Сверить дату остатков, если пишет что проблема с ценниками, пропускаем, загрузим позже 
Если внизу полоска, то все окей и загружается правильно 
После выполнения внизу будет писать ввод остатков (их обычно не больше 5) - значит все правильно иначе криво загрузились 
Затем закрываем 1с и в конфигуратор администрирование - выгрузка данных. Заменяет путь на наш магазин, чтобы получился путь с С диска 
Закрываем конфигуратор 

Открываем через батник открыть kb_y base открываем. Затем закидываем болванки на kb_y/Base/Cut_db

Закрываем эталонку 

## 4. Открываем магазин(ы) в тени на сервере 

### Запускаем батник "для обрезки БД". Он делает следующее:

На диске с в папке backup нам нужны rozn за 23 часа .bak и base архив (проверили что есть)

С/INSTALL создаём папку старая база и закидывает эти два файла 

Тоже самое закидывает на D диск (на всякий случай, вдруг диск помрёт)

На С/install разархивируем архив base 

Создаём baseold и закидываем папку туда и делаем к ней общий доступ (сверху в разделе поделиться - сделать недоступным - открываем доступ). Это для админской кассы

Затем заходим на kb_y/base/cutdb и болванку копируем на диск D 

В старой базе ищем userdef и копируем на d диск

ЭТО ВСЁ ДЕЛАЕТ БАТНИК И МОЖНО ДЕЛАТЬ ЗАРАНЕЕ 

ПАРОЛЬ просто нажать enter 
## SQL (это делает приложение "для обрезки БД(консольное))
Удаляем Rozn
Создаём новую, пишем имя Rozn
Ниже переименовываем Rozn -> Rozn_data 
В обеих сроках делаем авторасширение 64МБ

В параметрах выбрать совместимость с SQL 2000 и в пункте Автоматическое проставить True в двух местах 

Создаём Roznold, все то же самое, но в логическом имени не меняем, авторасширение 1МБ

Затем восстанавливает старую базу:
ПКМ по roznold -> задачи - восстановить - база 
данных 
В Общие выбрать с устройства выбрать на диске C/Backup/Rozn дата 23 00.bak
Ниде поставить галку на восстановить
В Параметры поставить галку "Перезаписать существующую базу данных" 
Восстановить как - выбираем старые базы и log файл на диске D/SQLDATA/Roznold и Roznold_log
Состояние восстановления 1 пункт 

---

## Установка болванки

**Закинуть актуальную с kb_y болванку на D диск удалив старую**
Заходим в 1С под конфигуратором (можно под специалистом - быстрее)

Затем в конфигураторе администрирование - загрузить данные - выбираем болванку на D диске - да да ок

Выходим из конфигуратора

USERDEF закидываем в новую болванку (уже установленную на D/Base с заменой) 

Заходим в конфигуратор (под специалистом)

Администрирование - параметры SQL - заполнить пользователя:
rwНОМЕР_МАГАЗИНА001
rozn
sa
159963
Выйти из конфигуратора

Заходим в 1С (можно под специалистом)
Резко пожимаем ДК загрузить и Цены загрузить 
Затем Операции - обработки - загрузка остатков марок в новую базу 

Можем в логах внизу увидеть за какое число он скачивает марки

Затем операции - обработки - ЗагрузкаСФТПДляФО

Проверяем номер магазина в константах и есть ли остатки в номенклатуре 

Заходим Журнал - Общие. Ставим период с начала месяца и проверяем загрузились ли остатки 

Заходим Егаис - штрихкоды марок (если бы не торговали алкоголем, то было бы пусто. Можно проверить в RW торгуют они или нет)
## Старая база 

Пока грузят марки заходим в 1С конфигуратор в старую базу под программистом. Администрирование - SQL - переименовываем rozn - roznold 
Заходим из конфигуратора в 1С
Операции - константы - НастроенТСД ставим 0

Закрываем 1С со старой базой и конфигуратор 

---

В конце в 1С загружаем цены, дк и марки 
Сверить, чтобы марки загрузились актуальные! Если загрузились старые, то их удалить и загрузить актуальные. Есть инструкция *как удалить марки из SQL*

---

Если марки качались не за то число
В папке обрезки БД есть батник скачать архивы с марками v3

---

**Как удалить марки из SQL** (Есть инструкция)

Зайти в SQL на магазине в тени 
Localhost - rozn таблица - ищем таблицу DBO.SC4668 - DELETE - новое окно редактора запросов - убрать WHERE и выполнить 

Затем загрузить через внешнюю обработку "ЗагрузкаОстатковМарокВНовуюБазуБезКонтроля.ert"

---

